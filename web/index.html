<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台程序管理控制台</title>
    <script src="feather.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        /* 顶部标签页 */
        .tab-bar {
            display: flex;
            background: rgba(25, 35, 65, 0.95);
            border-radius: 10px 10px 0 0;
            padding: 0 10px;
            height: 45px;
            overflow-x: auto;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .tab-bar::-webkit-scrollbar {
            height: 6px;
        }

        .tab-bar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .tab-bar::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 3px;
        }

        .tab {
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
            min-width: 150px;
            font-size: 0.95rem;
            color: #aaa;
            transition: all 0.2s;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: rgba(52, 152, 219, 0.2);
            color: #fff;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
        }

        .tab i {
            font-size: 0.9rem;
        }

        .close-tab {
            margin-left: 10px;
            padding: 3px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            transition: all 0.2s;
        }

        .close-tab:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        /* 主内容区 */
        .content-area {
            flex: 1;
            background: rgba(30, 30, 46, 0.85);
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        /* 程序管理标签页 */
        .program-management {
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 300;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #f8fafc;
            letter-spacing: -0.025em;
        }

        .section-title i {
            font-size: 1.3rem;
            color: #60a5fa;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            font-size: 0.9rem;
            letter-spacing: 0.025em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #2563eb, #7c3aed);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* 现代化程序列表 */
        .programs-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            align-content: start;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .programs-container::-webkit-scrollbar {
            width: 8px;
        }

        .programs-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .programs-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        .program-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 180px;
        }

        .program-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .program-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.12);
        }

        .program-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .program-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            word-break: break-word;
        }

        .program-name i {
            color: #60a5fa;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .status-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
            border: 1px solid;
            flex-shrink: 0;
        }

        .status.running {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .status.stopped {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .port-tag {
            padding: 4px 10px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .port-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .program-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .info-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .info-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: #fff;
        }

        .port-link {
            color: #60a5fa;
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
        }

        .port-link:hover {
            /* 移除字体颜色变化 */
        }

        .card-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            justify-content: space-between;
            align-items: center;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .start-btn {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .start-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .stop-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .stop-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .delete-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .delete-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .edit-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .edit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 标签页内容 */
        .tab-content {
            flex: 1;
            position: relative;
        }

        .tab-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        .no-tab {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            text-align: center;
            padding: 20px;
            background: rgba(25, 25, 40, 0.8);
        }

        .no-tab i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.1);
        }

        .no-tab h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #4ecdc4;
            font-weight: 600;
        }

        .no-tab p {
            font-size: 1.1rem;
            max-width: 600px;
            line-height: 1.6;
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1e2a5e, #2c3e50);
            border-radius: 15px;
            width: auto;
            max-width: 600px;
            max-height: 90vh;
            min-width: 400px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: auto;
        }

        .modal-header {
            padding: 20px;
            background: rgba(30, 40, 70, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.95rem;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            background: rgba(44, 44, 66, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
        }

        /* 响应式自适应样式 */
        @media (max-width: 768px) {
            .programs-container {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 10px 5px;
            }
            
            .program-card {
                min-width: auto;
                width: 100%;
            }
            
            .modal-content {
                max-width: 95vw;
                margin: 10px;
            }
            
            .program-management {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .programs-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .program-card {
                padding: 15px;
                min-width: auto;
            }
            
            .card-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .action-btn {
                width: 100%;
            }
        }

        /* 内容自适应包装 */
        .content-wrapper {
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 100vh;
            width: 100%;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-footer {
            padding: 20px;
            background: rgba(30, 40, 70, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn-secondary {
            background: rgba(149, 165, 166, 0.5);
        }

        /* 动画效果 */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .running {
            animation: pulse 2s infinite;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .programs-container {
                grid-template-columns: 1fr;
            }
            
            .tab {
                min-width: 120px;
                padding: 0 15px;
            }
            
            .management-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
        /* 确保Feather图标可见 */
        .feather {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标签页栏 -->
        <div class="tab-bar" id="tabBar">
            <!-- 程序管理标签页（固定） -->
            <div class="tab active" id="managementTab">
                <i data-feather="server" style="width: 16px; height: 16px;"></i>
                <span>程序管理</span>
            </div>
            <!-- 服务标签页将通过JS动态生成 -->
        </div>

        <!-- 内容区域 -->
        <div class="content-area">
            <!-- 程序管理标签页内容 -->
            <div class="program-management" id="managementContent">
                <div class="management-header">
                    <h2 class="section-title"><i data-feather="list" style="width: 20px; height: 20px;"></i> 已添加程序</h2>
                    <button class="btn" id="addProgramBtn">
                        <i data-feather="plus" style="width: 16px; height: 16px;"></i> 添加新程序
                    </button>
                </div>
                
                <div class="programs-container" id="programsContainer">
                    <!-- 程序卡片通过JS动态生成 -->
                </div>
            </div>
            
            <!-- 服务标签页内容 -->
            <div class="tab-content">
                <div class="no-tab" id="noTabMessage">
                    <i data-feather="maximize-2" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <h3>欢迎使用后台程序管理系统</h3>
                    <p>点击程序卡片中的端口号可在内嵌标签页中打开该服务<br>使用"添加新程序"按钮添加需要管理的后台程序</p>
                </div>
                <!-- 服务标签页内容通过JS动态生成 -->
            </div>
        </div>
    </div>

    <!-- 添加程序模态框 -->
    <div class="modal" id="addProgramModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i data-feather="plus-circle" style="width: 20px; height: 20px;"></i> 添加新程序</h2>
                <div class="close-modal" id="closeModalBtn" style="display: flex; align-items: center; justify-content: center;">
                    <i data-feather="x" style="width: 20px; height: 20px;"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="programName">程序名称</label>
                    <input type="text" id="programName" placeholder="输入程序名称">
                </div>
                <div class="form-group">
                    <label for="programPath">启动命令</label>
                    <input type="text" id="programPath" placeholder="输入启动命令（如：npm start, python app.py）">
                </div>
                <div class="form-group">
                    <label for="programDirectory">工作目录</label>
                    <input type="text" id="programDirectory" placeholder="输入工作目录路径（可选，默认为当前目录）">
                </div>
                <div class="form-group">
                    <label for="programPort">运行端口</label>
                    <input type="number" id="programPort" placeholder="输入端口号" min="1" max="65535">
                </div>
                <div class="form-group">
                    <label for="programType">程序描述</label>
                    <input type="text" id="programType" placeholder="输入程序描述（可选）">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddBtn">取消</button>
                <button class="btn" id="submitProgramBtn">添加程序</button>
            </div>
        </div>
    </div>

    <script>
        let programs = [];
        let tabs = [];
        let activeTabId = "managementTab";

        // 刷新Feather图标
        function refreshIcons() {
            if (typeof feather !== 'undefined' && feather.replace) {
                try {
                    feather.replace();
                } catch (error) {
                    console.error('Error refreshing icons:', error);
                }
            }
        }

        // 渲染程序卡片
        function renderPrograms() {
            const container = document.getElementById('programsContainer');
            container.innerHTML = '';
            
            if (programs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 60px;">
                        <i data-feather="zap" style="width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h3 style="font-size: 1.5rem; margin-bottom: 12px; font-weight: 300;">开始管理您的程序</h3>
                        <p style="font-size: 1.1rem; opacity: 0.7;">添加第一个程序，让后台管理变得简单优雅</p>
                    </div>
                `;
                return;
            }
            
            programs.forEach(program => {
                const card = document.createElement('div');
                card.className = `program-card ${program.status === 'running' ? 'running' : ''}`;
                
                card.innerHTML = `
                    <div class="program-header">
                        <div class="program-name">
                            <i data-feather="globe" style="width: 16px; height: 16px;"></i>
                            ${program.name}
                        </div>
                        <div class="status-container">
                            <div class="port-tag status ${program.status}" style="display: flex; align-items: center; gap: 4px;">
                                ${program.port ? `<i data-feather="external-link" style="width: 12px; height: 12px;"></i>端口: ${program.port}` : ''}
                            </div>
                            <div class="status ${program.status}">
                                ${program.status === 'running' ? '运行中' : '已停止'}
                            </div> 
                            
                        </div>
                    </div>
                    
                    <div class="program-info">
                        <div class="info-column">
                            <div class="info-item">
                                <span class="info-label">命令</span>
                                <span class="info-value" title="${program.command}">${program.command}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">工作目录</span>
                                <span class="info-value" title="${program.directory}">${program.directory || '.'}</span>
                            </div>
                        </div>
                        <div class="info-column">
                            <div class="info-item">
                                <span class="info-label">CPU</span>
                                <span class="info-value">${program.cpu || '0%'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">内存</span>
                                <span class="info-value">${program.memory || '0MB'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <button class="action-btn start-btn" data-id="${program.id}" ${program.status === 'running' ? 'disabled' : ''} title="启动">
                            <i data-feather="play" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="action-btn stop-btn" data-id="${program.id}" ${program.status === 'stopped' ? 'disabled' : ''} title="停止">
                            <i data-feather="square" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="action-btn edit-btn" data-id="${program.id}" title="编辑">
                            <i data-feather="edit-3" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${program.id}" title="删除">
                            <i data-feather="trash-2" style="width: 14px; height: 14px;"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // 添加端口标签点击事件
            document.querySelectorAll('.port-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const port = this.textContent.replace('端口: ', '').trim();
                    const name = this.closest('.program-card').querySelector('.program-name').textContent.trim();
                    openTab(port, name);
                });
            });
            
            // 添加按钮事件
            document.querySelectorAll('.start-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    startProgram(id);
                });
            });
            
            document.querySelectorAll('.stop-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    stopProgram(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteProgram(id);
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editProgram(id);
                });
            });
            
            // 渲染完成后刷新图标
            refreshIcons();
        }
        

        
        // 启动程序
        async function startProgram(id) {
            try {
                const response = await fetch(`/api/programs/${id}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`已启动: ${result.name}`, 'success');
                    await loadPrograms(); // 重新加载程序列表
                } else {
                    showNotification(result.message || '启动程序失败', 'danger');
                }
            } catch (error) {
                console.error('启动程序时出错:', error);
                showNotification('启动程序失败: ' + error.message, 'danger');
            }
        }
        
        // 停止程序
        async function stopProgram(id) {
            try {
                const response = await fetch(`/api/programs/${id}/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`已停止: ${result.name}`, 'warning');
                    await loadPrograms(); // 重新加载程序列表
                } else {
                    showNotification(result.message || '停止程序失败', 'danger');
                }
            } catch (error) {
                console.error('停止程序时出错:', error);
                showNotification('停止程序失败: ' + error.message, 'danger');
            }
        }
        
        // 编辑程序
        async function editProgram(id) {
            const program = programs.find(p => p.id === id);
            if (!program) return;

            // 创建编辑表单
            const form = document.createElement('div');
            form.className = 'edit-form';
            form.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <h3>编辑程序 - ${program.name}</h3>
                        <form id="editForm">
                            <div class="form-group">
                                <label>程序名称</label>
                                <input type="text" id="editName" value="${program.name}" required>
                            </div>
                            <div class="form-group">
                                <label>启动命令</label>
                                <input type="text" id="editCommand" value="${program.command}" required>
                            </div>
                            <div class="form-group">
                                <label>工作目录</label>
                                <input type="text" id="editDirectory" value="${program.directory || ''}">
                            </div>
                            <div class="form-group">
                                <label>端口号</label>
                                <input type="number" id="editPort" value="${program.port || ''}" min="1" max="65535">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-cancel">取消</button>
                                <button type="submit" class="btn-save">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                }
                .modal-content {
                    background: rgba(30, 41, 59, 0.95);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 16px;
                    padding: 32px;
                    width: 90%;
                    max-width: 500px;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                }
                .modal-content h3 {
                    margin-bottom: 24px;
                    color: #f8fafc;
                    font-weight: 300;
                }
                .form-group {
                    margin-bottom: 20px;
                }
                .form-group label {
                    display: block;
                    margin-bottom: 8px;
                    color: rgba(255, 255, 255, 0.8);
                    font-size: 0.9rem;
                }
                .form-group input {
                    width: 100%;
                    padding: 12px;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    background: rgba(255, 255, 255, 0.05);
                    color: #f8fafc;
                    font-size: 1rem;
                }
                .form-group input:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
                }
                .form-actions {
                    display: flex;
                    gap: 12px;
                    justify-content: flex-end;
                    margin-top: 24px;
                }
                .btn-cancel, .btn-save {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 0.9rem;
                    transition: all 0.2s ease;
                }
                .btn-cancel {
                    background: rgba(255, 255, 255, 0.1);
                    color: rgba(255, 255, 255, 0.8);
                }
                .btn-cancel:hover {
                    background: rgba(255, 255, 255, 0.2);
                }
                .btn-save {
                    background: linear-gradient(135deg, #3b82f6, #2563eb);
                    color: white;
                }
                .btn-save:hover {
                    /* 移除背景渐变变化 */
                }
            `;

            document.head.appendChild(style);
            document.body.appendChild(form);

            // 处理表单提交
            form.querySelector('#editForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // 禁用保存按钮防止重复点击
                const saveBtn = form.querySelector('.btn-save');
                saveBtn.disabled = true;
                saveBtn.textContent = '保存中...';
                
                const updatedProgram = {
                    name: document.getElementById('editName').value,
                    command: document.getElementById('editCommand').value,
                    working_dir: document.getElementById('editDirectory').value,
                    port: parseInt(document.getElementById('editPort').value) || null
                };

                try {
                    console.log('开始保存程序:', updatedProgram);
                    
                    const response = await fetch(`/api/programs/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedProgram)
                    });

                    console.log('服务器响应状态:', response.status);

                    let result;
                    if (response.ok) {
                        try {
                            result = await response.json();
                            console.log('保存成功:', result);
                            showNotification('程序已更新', 'success');
                            document.body.removeChild(form);
                            document.head.removeChild(style);
                            await loadPrograms();
                        } catch (jsonError) {
                            console.error('解析JSON响应失败:', jsonError);
                            showNotification('保存成功但解析响应失败', 'success');
                            document.body.removeChild(form);
                            document.head.removeChild(style);
                            await loadPrograms();
                        }
                    } else {
                        // 对于错误响应，先尝试读取JSON，如果失败则读取文本
                        const contentType = response.headers.get('content-type');
                        let errorMessage;
                        
                        if (contentType && contentType.includes('application/json')) {
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.message || errorData.error || '更新程序失败';
                            } catch (e) {
                                errorMessage = '更新程序失败';
                            }
                        } else {
                            try {
                                errorMessage = await response.text();
                            } catch (e) {
                                errorMessage = response.statusText || '更新程序失败';
                            }
                        }
                        
                        console.error('保存失败:', errorMessage);
                        showNotification(errorMessage, 'danger');
                    }
                } catch (error) {
                    console.error('更新程序时出错:', error);
                    showNotification('更新程序失败: ' + error.message, 'danger');
                } finally {
                    // 恢复保存按钮状态
                    saveBtn.disabled = false;
                    saveBtn.textContent = '保存';
                }
            });

            // 处理取消按钮
            form.querySelector('.btn-cancel').addEventListener('click', () => {
                document.body.removeChild(form);
                document.head.removeChild(style);
            });

            // 点击遮罩层关闭
            form.querySelector('.modal-overlay').addEventListener('click', (e) => {
                if (e.target === form.querySelector('.modal-overlay')) {
                    document.body.removeChild(form);
                    document.head.removeChild(style);
                }
            });
        }

        // 删除程序
        async function deleteProgram(id) {
            if (!confirm('确定要删除此程序吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/programs/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    showNotification('程序已删除', 'danger');
                    await loadPrograms(); // 重新加载程序列表
                    
                    // 如果没有程序了，停止状态更新
                    if (programs.length === 0) {
                        stopStatusUpdates();
                    }
                } else {
                    // 对于错误响应，先尝试读取JSON，如果失败则读取文本
                    const contentType = response.headers.get('content-type');
                    let errorMessage;
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.error || '删除程序失败';
                        } catch (e) {
                            errorMessage = '删除程序失败';
                        }
                    } else {
                        try {
                            errorMessage = await response.text();
                        } catch (e) {
                            errorMessage = response.statusText || '删除程序失败';
                        }
                    }
                    
                    showNotification(errorMessage, 'danger');
                }
            } catch (error) {
                console.error('删除程序时出错:', error);
                showNotification('删除程序失败: ' + error.message, 'danger');
            }
        }
        
        // 添加新程序
        async function addProgram() {
            const name = document.getElementById('programName').value.trim();
            const command = document.getElementById('programPath').value.trim();
            const port = document.getElementById('programPort').value;
            const type = document.getElementById('programType').value;
            const directory = document.getElementById('programDirectory').value.trim() || '.';
            
            if (!name || !command) {
                showNotification('程序名称和命令不能为空', 'danger');
                return;
            }
            
            if (port && (port < 1 || port > 65535)) {
                showNotification('端口号必须在1-65535之间', 'danger');
                return;
            }
            
            try {
                const response = await fetch('/api/programs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        command: command,
                        port: port ? parseInt(port) : 0,
                        working_dir: directory,
                        description: type || 'Web application'
                    })
                });

                let result;
                if (response.ok) {
                    result = await response.json();
                    showNotification(`已添加: ${name}`, 'success');
                    await loadPrograms(); // 重新加载程序列表
                    
                    // 如果有程序了，启动状态更新
                    if (programs.length > 0 && !statusUpdateInterval) {
                        startStatusUpdates();
                    }
                    
                    // 清空表单并关闭模态框
                    document.getElementById('programName').value = '';
                    document.getElementById('programPath').value = '';
                    document.getElementById('programPort').value = '';
                    document.getElementById('programDirectory').value = '';
                    document.getElementById('addProgramModal').style.display = 'none';
                } else {
                    // 对于错误响应，先尝试读取JSON，如果失败则读取文本
                    const contentType = response.headers.get('content-type');
                    let errorMessage;
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.error || '添加程序失败';
                        } catch (e) {
                            errorMessage = '添加程序失败';
                        }
                    } else {
                        try {
                            errorMessage = await response.text();
                        } catch (e) {
                            errorMessage = response.statusText || '添加程序失败';
                        }
                    }
                    
                    showNotification(errorMessage, 'danger');
                }
            } catch (error) {
                console.error('添加程序时出错:', error);
                showNotification('添加程序失败: ' + error.message, 'danger');
            }
        }
        
        // 打开新标签页
        function openTab(port, name) {
            // 检查标签页是否已存在
            const existingTab = tabs.find(tab => tab.port === port);
            if (existingTab) {
                setActiveTab(existingTab.id);
                return;
            }
            
            const tabId = `tab-${Date.now()}`;
            const hostname = window.location.hostname;
            const tab = {
                id: tabId,
                port: port,
                name: name,
                url: `http://${hostname}:${port}`
            };
            
            tabs.push(tab);
            renderTabs();
            setActiveTab(tabId);
            showNotification(`已打开: ${hostname} (${port})`, 'info');
        }
        
        // 渲染标签页
        function renderTabs() {
            const tabBar = document.getElementById('tabBar');
            
            // 移除除程序管理外的所有标签页
            const tabsToRemove = Array.from(tabBar.querySelectorAll('.tab')).filter(tab => tab.id !== 'managementTab');
            tabsToRemove.forEach(tab => tab.remove());
            
            // 添加服务标签页
            tabs.forEach(tab => {
                const tabElement = document.createElement('div');
                tabElement.className = `tab ${activeTabId === tab.id ? 'active' : ''}`;
                tabElement.id = tab.id;
                
                tabElement.innerHTML = `
                    <i data-feather="maximize-2" style="width: 14px; height: 14px;"></i>
                    <span>${tab.name}:${tab.port}</span>
                    <div class="close-tab">
                        <i data-feather="x" style="width: 14px; height: 14px;"></i>
                    </div>
                `;
                
                // 点击标签页
                tabElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('close-tab') && 
                        !e.target.parentElement.classList.contains('close-tab')) {
                        setActiveTab(tab.id);
                    }
                });
                
                // 关闭标签页
                const closeBtn = tabElement.querySelector('.close-tab');
                closeBtn.addEventListener('click', () => {
                    closeTab(tab.id);
                });
                
                tabBar.appendChild(tabElement);
            });
            
            // 更新标签页内容
            const tabContent = document.querySelector('.tab-content');
            tabContent.innerHTML = '';
            
            // 渲染标签页后刷新图标
            setTimeout(refreshIcons, 100);
            
            const managementContent = document.getElementById('managementContent');
            const noTabMessage = document.getElementById('noTabMessage');
            
            if (activeTabId === 'managementTab') {
                if (managementContent) managementContent.style.display = 'flex';
                if (noTabMessage) noTabMessage.style.display = 'none';
                return;
            }
            
            if (managementContent) managementContent.style.display = 'none';
            
            if (tabs.length === 0) {
                if (noTabMessage) noTabMessage.style.display = 'flex';
                return;
            }
            
            const activeTab = tabs.find(tab => tab.id === activeTabId);
            if (activeTab) {
                const iframe = document.createElement('iframe');
                iframe.className = 'tab-iframe';
                iframe.src = activeTab.url;
                tabContent.appendChild(iframe);
                if (noTabMessage) noTabMessage.style.display = 'none';
            }
        }
        
        // 设置活动标签页
        function setActiveTab(tabId) {
            activeTabId = tabId;
            renderTabs();
        }
        
        // 关闭标签页
        function closeTab(tabId) {
            const tabIndex = tabs.findIndex(tab => tab.id === tabId);
            if (tabIndex !== -1) {
                tabs.splice(tabIndex, 1);
                
                // 如果关闭的是活动标签页，设置程序管理标签为活动状态
                if (activeTabId === tabId) {
                    activeTabId = "managementTab";
                }
                
                renderTabs();
            }
        }
        
        // 显示通知
        function showNotification(message, type) {
            // 在实际应用中，这里会显示一个通知
            console.log(`${type}: ${message}`);
        }
        
        // 加载程序列表
        async function loadPrograms() {
            try {
                const response = await fetch('/api/programs');
                if (response.ok) {
                    const data = await response.json();
                    programs = data.map(program => ({
                        id: program.id,
                        name: program.name,
                        command: program.command,
                        port: program.port ? parseInt(program.port) : null,
                        type: 'web',
                        status: program.status || 'stopped',
                        cpu: '0%',
                        memory: '0MB',
                        directory: program.working_dir || '.'
                    }));
                    renderPrograms();
                } else {
                    console.error('加载程序列表失败');
                    showNotification('加载程序列表失败', 'danger');
                }
            } catch (error) {
                console.error('加载程序列表时出错:', error);
                showNotification('加载程序列表失败: ' + error.message, 'danger');
            }
        }

        // 加载程序状态
        async function loadProgramStatus() {
            try {
                const response = await fetch('/api/programs/memory');
                if (response.ok) {
                    const statusData = await response.json();
                    
                    // 只更新当前存在的程序状态，过滤掉已删除的程序
                    const validPrograms = [];
                    programs.forEach(program => {
                        const status = statusData.find(s => s.id === program.id);
                        if (status) {
                            program.status = status.status || 'stopped';
                            program.cpu = status.cpu_usage || '0%';
                            program.memory = status.memoryUsage || '0MB';
                            validPrograms.push(program);
                        }
                        // 如果status为undefined，说明程序可能已被删除，不添加到validPrograms中
                    });
                    
                    // 更新程序列表，移除已不存在的程序
                    programs = validPrograms;
                    renderPrograms();
                }
            } catch (error) {
                console.error('加载程序状态失败:', error);
            }
        }

        // 初始化页面
        let statusUpdateInterval;
        
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化Feather Icons
            function initFeatherIcons() {
                if (typeof feather !== 'undefined' && feather.replace) {
                    try {
                        feather.replace();
                        console.log('Feather icons initialized successfully');
                    } catch (error) {
                        console.error('Error initializing feather icons:', error);
                    }
                } else {
                    console.error('Feather icons library not loaded');
                    // 重试机制
                    setTimeout(initFeatherIcons, 1000);
                }
            }
            
            initFeatherIcons();
            
            loadPrograms();
            renderTabs();
            
            // 添加程序按钮事件
            document.getElementById('addProgramBtn').addEventListener('click', function() {
                document.getElementById('addProgramModal').style.display = 'flex';
            });
            
            // 关闭模态框按钮
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                document.getElementById('addProgramModal').style.display = 'none';
            });
            
            document.getElementById('cancelAddBtn').addEventListener('click', function() {
                document.getElementById('addProgramModal').style.display = 'none';
            });
            
            // 添加程序提交按钮
            document.getElementById('submitProgramBtn').addEventListener('click', addProgram);
            
            // 程序管理标签页点击事件
            document.getElementById('managementTab').addEventListener('click', function() {
                setActiveTab('managementTab');
            });
            
            // 启动状态更新定时器
            startStatusUpdates();
        });
        
        // 启动状态更新
        function startStatusUpdates() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            statusUpdateInterval = setInterval(() => {
                if (programs.length > 0) {
                    loadProgramStatus();
                }
            }, 3000);
        }
        
        // 停止状态更新
        function stopStatusUpdates() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
        }
    </script>
</body>
</html>